From fb168fa3f3403dcacf4c644be86683f1c73dbd1e Mon Sep 17 00:00:00 2001
From: sharpenedblade <sharpenedblade@proton.me>
Date: Mon, 28 Nov 2022 16:57:08 -0800
Subject: [PATCH 1/3] Add function to check for T2 apple macs.

---
 blivet/arch.py | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/blivet/arch.py b/blivet/arch.py
index 4a9805e57..bcedd767e 100644
--- a/blivet/arch.py
+++ b/blivet/arch.py
@@ -40,6 +40,7 @@
 
 # DMI information paths
 DMI_CHASSIS_VENDOR = "/sys/class/dmi/id/chassis_vendor"
+DMI_PRODUCT_ID = "/sys/class/dmi/id/product_id"
 
 
 def get_ppc_machine():
@@ -198,6 +199,29 @@ def is_cell():
     return False
 
 
+def is_t2mac():
+    """
+    :return: True if the hardware is an Intel-based Apple Mac with the T2 security chip, False otherwise.
+    :rtype boolean
+
+    """
+    APPLE_T2_PRODUCT_NAMES = {
+        "iMac20,2", "iMac20,1", "iMacPro1,1",
+        "MacPro7,1", "Macmini8,1", "MacBookAir9,1", "MacBookAir8,2",
+        "MacBookAir8,1", "MacBookPro16,4", "MacBookPro16,3", "MacBookPro16,2",
+        "MacBookPro16,1", "MacBookPro15,4", "MacBookPro15,3", "MacBookPro15,2",
+        "MacBookPro15,1",
+        }
+    if not is_x86():
+        t2_mac = False
+    elif not os.path.isfile(DMI_PRODUCT_ID):
+        t2_mac = False
+    else:
+        buf = open(DMI_PRODUCT_ID).read()
+        t2_mac = (buf in APPLE_T2_PRODUCT_NAMES)
+    return t2_mac
+
+
 def is_mactel():
     """
     :return: True if the hardware is an Intel-based Apple Mac, False otherwise.

From 384878d10dc2fefd02fb43c45b5cd14c3fccff7b Mon Sep 17 00:00:00 2001
From: sharpenedblade <sharpenedblade@proton.me>
Date: Mon, 28 Nov 2022 17:01:40 -0800
Subject: [PATCH 2/3] Do not report mactel on T2 macs.

---
 blivet/arch.py | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/blivet/arch.py b/blivet/arch.py
index bcedd767e..c56db0a19 100644
--- a/blivet/arch.py
+++ b/blivet/arch.py
@@ -232,6 +232,8 @@ def is_mactel():
         mactel = False
     elif not os.path.isfile(DMI_CHASSIS_VENDOR):
         mactel = False
+    elif is_t2mac():
+        mactel = False
     else:
         try:
             buf = open(DMI_CHASSIS_VENDOR).read()

From fd0a538f2fbdf7d6500f0684d986d1da2c460e01 Mon Sep 17 00:00:00 2001
From: sharpenedblade <sharpenedblade@proton.me>
Date: Tue, 29 Nov 2022 16:04:14 -0800
Subject: [PATCH 3/3] Style changes.

---
 blivet/arch.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/blivet/arch.py b/blivet/arch.py
index c56db0a19..9b35e663e 100644
--- a/blivet/arch.py
+++ b/blivet/arch.py
@@ -211,7 +211,7 @@ def is_t2mac():
         "MacBookAir8,1", "MacBookPro16,4", "MacBookPro16,3", "MacBookPro16,2",
         "MacBookPro16,1", "MacBookPro15,4", "MacBookPro15,3", "MacBookPro15,2",
         "MacBookPro15,1",
-        }
+    }
     if not is_x86():
         t2_mac = False
     elif not os.path.isfile(DMI_PRODUCT_ID):

